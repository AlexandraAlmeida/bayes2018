---
title: "Bayesian Survival Analysis"
author: "Kazuki Yoshida"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r, message = FALSE, tidy = FALSE, echo = F}
## knitr configuration: http://yihui.name/knitr/options#chunk_options
library(knitr)
showMessage <- FALSE
showWarning <- TRUE
set_alias(w = "fig.width", h = "fig.height", res = "results")
opts_chunk$set(comment = "##", error= TRUE, warning = showWarning, message = showMessage,
               tidy = FALSE, cache = F, echo = T,
               fig.width = 7, fig.height = 7, dev.args = list(family = "sans"))
## for rgl
## knit_hooks$set(rgl = hook_rgl, webgl = hook_webgl)
## for animation
opts_knit$set(animation.fun = hook_ffmpeg_html)

## R configuration
options(width = 116, scipen = 5)
```

## References
- [Stan for survival models](https://discourse.mc-stan.org/t/stan-for-survival-models/4146)
- Books
-
- R packages
  - [bayesSurv: Bayesian Survival Regression with Flexible Error and Random Effects Distributions](https://cran.r-project.org/web/packages/bayesSurv/index.html)
  - [survHE: Survival Analysis in Health Economic Evaluation](https://cran.r-project.org/web/packages/survHE/index.html)
  - [biostan: Introduction to Bayesian Inference using Stan with Applications to Cancer Genomics](https://github.com/jburos/biostan)
- SurvivalStan (Python)
  - [Introducing SurvivalStan](http://www.hammerlab.org/2017/06/26/introducing-survivalstan/)
  - [Github SurvivalStan](https://github.com/hammerlab/survivalstan)


## Background
Survival analysis is at the core of epidemiological data analysis. There are multiple well-known Bayesian data analysis textbooks, but they typically do not cover survival analysis. Here we will show case some R examples of Bayesian survival analysis.


## Load packages

```{r}
library(tidyverse)
library(survminer)
library(bayesSurv)
## devtools::install_github('jburos/biostan', build_vignettes = TRUE, dependencies = TRUE)
library(biostan)
```


## Descriptive analysis example
### Load a simple dataset

```{r}
data(leukemia, package = "survival")
leukemia <- as_data_frame(leukemia)
leukemia
```

```
aml                  package:survival                  R Documentation
Acute Myelogenous Leukemia survival data
Description:
     Survival in patients with Acute Myelogenous Leukemia.  The
     question at the time was whether the standard course of
     chemotherapy should be extended ('maintainance') for additional
     cycles.
Usage:
     aml
     leukemia
Format:
       time:    survival or censoring time
       status:  censoring status
       x:       maintenance chemotherapy given? (factor)
Source:
     Rupert G. Miller (1997), _Survival Analysis_.  John Wiley & Sons.
     ISBN: 0-471-25218-2.
```


### Regular Kaplan-Meier plot

```{r}
km_fit <- survfit(Surv(time, status) ~ x, data = leukemia)
km_fit
## http://www.sthda.com/english/wiki/survminer-0-2-4
ggsurvplot(km_fit,
           conf.int = TRUE,
           break.time.by = 20,
           risk.table = TRUE)
```

### Stan Weibull fit

Here we will use the Weibull model code available in [biostan](https://github.com/jburos/biostan).

```{r}
stan_weibull_survival_model_file <- system.file('stan', 'weibull_survival_model.stan', package =  'biostan')
biostan::print_stan_file(stan_weibull_survival_model_file)
```

From the data block, observations where events were observed and censored are handled separately. No hyperparameters for the priors are specified here. They are hard-coded.

```{r}
stan_weibull_survival_model_code <- biostan::read_stan_file(stan_weibull_survival_model_file)
biostan::print_stan_code(stan_weibull_survival_model_code, section = "data")
```




## Recurrent event example

```{r}
data(cgd, package = "bayesSurv")
cgd <- as_data_frame(cgd)
cgd
```


--------------------
- Top Page: http://rpubs.com/kaz_yos/
- Github: https://github.com/kaz-yos
