---
title: "BUGS book Measurement Error"
author: "Kazuki Yoshida"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r, message = FALSE, tidy = FALSE, echo = F}
## knitr configuration: http://yihui.name/knitr/options#chunk_options
library(knitr)
showMessage <- FALSE
showWarning <- TRUE
set_alias(w = "fig.width", h = "fig.height", res = "results")
opts_chunk$set(comment = "##", error= TRUE, warning = showWarning, message = showMessage,
               tidy = FALSE, cache = FALSE, echo = TRUE,
               fig.width = 7, fig.height = 7, dev.args = list(family = "sans"))
## for rgl
## knit_hooks$set(rgl = hook_rgl, webgl = hook_webgl)
## for animation
opts_knit$set(animation.fun = hook_ffmpeg_html)
## R configuration
options(width = 116, scipen = 5)
## Record start time
start_time <- Sys.time()
## Configure parallelization
## Parallel backend for foreach (also loads foreach and parallel; includes doMC)
library(doParallel)
## Reproducible parallelization
library(doRNG)
## Detect core count (Do not use on clusters)
n_cores <- parallel::detectCores()
## Used by parallel::mclapply() as default
options(mc.cores = n_cores)
## Used by doParallel as default
options(cores = n_cores)
## Register doParallel as the parallel backend for foreach
## http://stackoverflow.com/questions/28989855/the-difference-between-domc-and-doparallel-in-r
doParallel::registerDoParallel(cores = n_cores)
```

## References
- BUGS book 9.3 Measurement Error
- http://www.openbugs.net/Examples/Cervix.html
- https://github.com/stan-dev/example-models/tree/master/bugs_examples/vol2/cervix
- Gustafson. Measurement Error and Misclassification. Chapter 4. p55.

## Load packages

```{r}
library(tidyverse)
library(ggdag)
library(biostan)
library(rstan)
```

## Load data

The dataset is a case-control study on the outcome of invasive cervical cancer and the exposure of herpes simplex virus (HSV). Let $Y$ be the binary outcome, $X_{true}$ be the true binary covariate, and $X_{mis}$ be the mismeasured binary covariate. The dataset contains an internal validation dataset with both $X_{true}$ and $X_{mis}$. The rest of the dataset only has $X_{mis}$. Let $R_{X}$ be the indicator to indicate that $X_{true}$ was observed for that row.

```{r}
cervical <- tribble(
    ~Y, ~X_true, ~X_mis, ~count, ~R_X,
    ## Complete data for the internal validation set
    1, 0, 0, 13, 1,
    1, 0, 1,  3, 1,
    1, 1, 0,  5, 1,
    1, 1, 1, 18, 1,
    0, 0, 0, 33, 1,
    0, 0, 1, 11, 1,
    0, 1, 0, 16, 1,
    0, 1, 1, 16, 1,
    ## Incomplete data for the rest of the dataset
    1, NA, 0, 318, 0,
    1, NA, 1, 375, 0,
    0, NA, 0, 701, 0,
    0, NA, 1, 535, 0
)
cervical
cervical <- cervical %>%
    mutate(X_true = if_else(is.na(X_true), -1, X_true))
```

## Model

The model considered is a classical mismeasurement model represented in the following model DAG that also contains parameters. This type of DAGs with parameters in them are commonly seen in the Bayesian literature, in particular to describe hierarchical models. Here we also have the missing indicator assuming MCAR (validation subset is a random subsample within the sample).

```{r}
dagify(Y ~ Xt, Xm ~ Xt, Xm ~ phi, Xt ~ psi, Y ~ beta, Rx ~ gamma) %>%
    ggdag()
```

Since the missing process is ignorable, we can work on the other parts only. We partition the true exposure $X_{true}$ into the complete part $X_{true}^{c}$ and the reduced part $X_{true}^{r}$ (missing part). The posterior given the observed data is the following.

$$\begin{align*}
  p(X_{true}^{r}, \beta, \phi, \psi | Y, X_{mis}, X_{true}^{c})
  &\propto p(\beta, \phi, \psi, Y, X_{mis}, X_{true})\\
  \\
  &= p(Y, X_{mis}, X_{true} | \beta, \phi, \psi) p(\beta, \phi, \psi)\\
  \\
  &=
    p(Y | X_{mis}, X_{true}, \beta, \phi, \psi)
    p(X_{mis} | X_{true}, \beta, \phi, \psi)
    p(X_{true} | \beta, \phi, \psi)
    p(\beta, \phi, \psi)\\
  \\
  &~~~~\text{Using conditional independences in the DAG}\\
  \\
  &=
    \underbrace{p(Y | X_{true}, \beta)}_{\text{outcome model}}
    \underbrace{p(X_{mis} | X_{true},  \phi)}_{\text{error model}}
    \underbrace{p(X_{true} | \psi)}_{\text{covariate model}}
    \underbrace{p(\beta)p(\phi)p(\psi)}_{\text{priors}}\\
  \end{align*}
$$

The posterior of the parameters given the observed data is the following for the incomplete part of the data.



## Stan implementation

```{r}
model1_code <- biostan::read_stan_file("./mismeasurement_bugs_book.stan")
biostan::print_stan_code(model1_code)
```
```{r, results = "hide"}
model1 <- stan(model_code = model1_code,
               data = c(N = nrow(cervical),
                        as.list(cervical)),
               cores = n_cores)
```
```{r}
model1
traceplot(model1, pars = names(model1))
```
--------------------
- Top Page: http://rpubs.com/kaz_yos/
- Github: https://github.com/kaz-yos

```{r}
print(sessionInfo())
## Record execution time and multicore use
end_time <- Sys.time()
diff_time <- difftime(end_time, start_time, units = "auto")
cat("Started  ", as.character(start_time), "\n",
    "Finished ", as.character(end_time), "\n",
    "Time difference of ", diff_time, " ", attr(diff_time, "units"), "\n",
    "Used ", foreach::getDoParWorkers(), " cores\n",
    "Used ", foreach::getDoParName(), " as backend\n",
    sep = "")
```
