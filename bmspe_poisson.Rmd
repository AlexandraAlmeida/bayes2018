---
title: "Poisson Models"
author: "Kazuki Yoshida"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: html_document
---

```{r, message = FALSE, tidy = FALSE, echo = F}
## knitr configuration: http://yihui.name/knitr/options#chunk_options
library(knitr)
showMessage <- FALSE
showWarning <- TRUE
set_alias(w = "fig.width", h = "fig.height", res = "results")
opts_chunk$set(comment = "##", error= TRUE, warning = showWarning, message = showMessage,
               tidy = FALSE, cache = FALSE, echo = TRUE,
               fig.width = 7, fig.height = 7, dev.args = list(family = "sans"))
## for rgl
## knit_hooks$set(rgl = hook_rgl, webgl = hook_webgl)
## for animation
opts_knit$set(animation.fun = hook_ffmpeg_html)
## R configuration
options(width = 116, scipen = 5)
## Record start time
start_time <- Sys.time()
## Configure parallelization
## Parallel backend for foreach (also loads foreach and parallel; includes doMC)
library(doParallel)
## Reproducible parallelization
library(doRNG)
## Detect core count (Do not use on clusters)
n_cores <- parallel::detectCores()
## Used by parallel::mclapply() as default
options(mc.cores = n_cores)
## Used by doParallel as default
options(cores = n_cores)
## Register doParallel as the parallel backend for foreach
## http://stackoverflow.com/questions/28989855/the-difference-between-domc-and-doparallel-in-r
doParallel::registerDoParallel(cores = n_cores)
```

## References
- Web
  - [(DAE) Negative Binomial Regression | R Data Analysis Examples](https://stats.idre.ucla.edu/r/dae/negative-binomial-regression/)
  - [Negative binomial and mixed Poisson regression](http://www.math.mcgill.ca/~dstephens/523/Papers/Lawless-1987-CJS.pdf)
  - [Writing Stan programs for use with the loo package](http://mc-stan.org/loo/articles/loo2-with-rstan.html)
  - [4.A Models for Over-Dispersed Count Data](https://data.princeton.edu/wws509/stata/overdispersion)
  - [Models for Count Data With Overdispersion](https://data.princeton.edu/wws509/notes/c4a.pdf)
  - [An Introduction to ggdag](https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html)
- Books
  - [Bayesian Models: a Statistical Primer for Ecologists](https://press.princeton.edu/titles/10523.html)

## Load packages
```{r}
library(tidyverse)
## devtools::install_github('jburos/biostan', build_vignettes = TRUE, dependencies = TRUE)
library(rstan)
## To avoid recompilation of unchanged Stan programs, we recommend calling
rstan_options(auto_write = TRUE)
##
library(bayesplot)
##
library(loo)
## Seed from random.org
set.seed(673788956)
```

## Load data
```{r, cache = TRUE}
data1 <- haven::read_dta("https://stats.idre.ucla.edu/stat/stata/dae/nb_data.dta")
```
```{r}
data1 <- data1 %>%
    mutate(prog = factor(prog, levels = 1:3, labels = c("General", "Academic", "Vocational")),
           id = factor(id))
data1
## For counting
data1_count <- data1 %>%
    rename(y = daysabs) %>%
    count(y)
data1_count
```

## Visualize
```{r}
data1 %>%
    ggplot(mapping = aes(x = daysabs, fill = prog)) +
    geom_bar(stat = "count") +
    facet_grid(prog ~ ., margin = TRUE, scales = "free_y") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
          legend.key = element_blank(),
          plot.title = element_text(hjust = 0.5),
          strip.background = element_blank())
```

## Design matrix
I will assume the DAE design matrix is sufficient for modeling covariates.
```{r}
X <- model.matrix(object = daysabs ~ math + prog, data = data1)
head(X, n = 10)
```
```{r}
y <- data1$daysabs
```

## Helper functions
```{r}
##
extract_post_pred <- function(stan_fit) {
    tidybayes::tidy_draws(stan_fit) %>%
        select(.chain, .iteration, .draw, starts_with("y_new")) %>%
        gather(key = key, value = value, starts_with("y_new")) %>%
        mutate(key = gsub("y_new|\\[|\\]", "", key) %>% as.integer())
}
##
plot_draws <- function(stan_fit, n_sample) {
    draw_data <- extract_post_pred(stan_fit)
    sample_indices <- sample(seq_len(max(draw_data$.iteration)), size = n_sample)
    draw_data %>%
        group_by(.chain, .iteration, .draw) %>%
        count(value) %>%
        filter(.iteration %in% sample_indices) %>%
        ggplot(mapping = aes(x = value, y = n, group = interaction(.chain, .iteration, .draw))) +
        geom_line(alpha = 0.5, size = 0.1) +
        geom_line(data = data1_count, color = "gray", alpha = 0.7, size = 2,
                  mapping = aes(x = y, group = NULL)) +
        facet_wrap( ~ .chain) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
              legend.key = element_blank(),
              plot.title = element_text(hjust = 0.5),
              strip.background = element_blank())
}
```

## Poisson model without covariates
$$\begin{align*}
  &\text{Prior}\\
  \lambda | \alpha, \beta &\sim Gamma(\alpha, \beta)\\
  \\
  &\text{Likelihood}\\
  y_{i} | \lambda &\overset{\text{iid}}{\sim} Poisson(\lambda)\\
  \end{align*}
$$
```{r}
stan_code_poisson <- biostan::read_stan_file("./bmspe_poisson.stan")
biostan::print_stan_code(stan_code_poisson, section = NULL)
stan_model_poisson <- stan(model_code = stan_code_poisson,
                           data = list(a = 10^(-3), b = 10^(-3),
                                       N = nrow(X), M = ncol(X),
                                       X = X,
                                       y = y),
                           chains = n_cores, verbose = FALSE)
check_hmc_diagnostics(stan_model_poisson)
pars <- c("lambda","lp__")
print(stan_model_poisson, pars = pars)
pairs(stan_model_poisson, pars = pars)
traceplot(stan_model_poisson, inc_warmup = TRUE, pars = pars)
plot_draws(stan_model_poisson, n_sample = 20)
loo(stan_model_poisson)
```

## Poisson model with covariates
$$\begin{align*}
  &\text{Prior}\\
  \boldsymbol{\beta} &\sim MVN(\boldsymbol{0}, \mathbf{I})\\
  \\
  &\text{Likelihood}\\
  \eta_{i} &= \mathbf{X}_{i}^{T}\boldsymbol{\beta}\\
  \mu_{i} &= e^{\eta_{i}}\\
  y_{i} | \mu_{i} &\overset{\text{ind}}{\sim} Poisson(\mu_{i})\\
  \end{align*}
$$
```{r}
stan_code_poisson_covs <- biostan::read_stan_file("./bmspe_poisson_covs.stan")
biostan::print_stan_code(stan_code_poisson_covs, section = NULL)
stan_model_poisson_covs <- stan(model_code = stan_code_poisson_covs,
                                data = list(s = 10,
                                            N = nrow(X), M = ncol(X),
                                            X = X,
                                            y = y),
                                chains = n_cores, verbose = FALSE)
check_hmc_diagnostics(stan_model_poisson_covs)
pars <- c("beta","lp__")
print(stan_model_poisson_covs, pars = pars)
pairs(stan_model_poisson_covs, pars = pars)
traceplot(stan_model_poisson_covs, inc_warmup = TRUE, pars = pars)
plot_draws(stan_model_poisson_covs, n_sample = 20)
loo(stan_model_poisson_covs)
```


## Poisson model with covariates and gamma random effects
$$\begin{align*}
  &\text{Prior}\\
  \boldsymbol{\beta} &\sim MVN(\boldsymbol{0}, \mathbf{I})\\
  a_{\gamma} &\sim Gamma(a, b)\\
  \\
  &\text{Likelihood}\\
  \eta_{i} &= \mathbf{X}_{i}^{T}\boldsymbol{\beta}\\
  \mu_{i} &= e^{\eta_{i}}\\
  \gamma_{i} | a_{\gamma} &\overset{\text{iid}}{\sim} Gamma(1/a_{\gamma},1/a_{\gamma}) ~~ E[\gamma_{i}] = 1, Var(\gamma_{i}) = a_{\gamma}\\
  y_{i} | \gamma_{i},\mu_{i} &\overset{\text{ind}}{\sim} Poisson(\gamma_{i} \mu_{i})\\
  \end{align*}
$$
```{r}
stan_code_poisson_covs_gamma <- biostan::read_stan_file("./bmspe_poisson_covs_gamma.stan")
biostan::print_stan_code(stan_code_poisson_covs_gamma, section = NULL)
stan_model_poisson_covs_gamma <- stan(model_code = stan_code_poisson_covs_gamma,
                                      data = list(a = 10^(-3), b = 10^(-3),
                                                  s = 10,
                                                  N = nrow(X), M = ncol(X),
                                                  X = X,
                                                  y = y),
                                      chains = n_cores, verbose = FALSE)
check_hmc_diagnostics(stan_model_poisson_covs_gamma)
pars <- c("beta","aa","lp__")
print(stan_model_poisson_covs_gamma, pars = pars)
pairs(stan_model_poisson_covs_gamma, pars = pars)
traceplot(stan_model_poisson_covs_gamma, inc_warmup = TRUE, pars = pars)
plot_draws(stan_model_poisson_covs_gamma, n_sample = 20)
loo(stan_model_poisson_covs_gamma)
```


## Model comparison
```{r}
loo(stan_model_poisson, stan_model_poisson_covs, stan_model_poisson_covs_gamma)
```

--------------------
- Top Page: http://rpubs.com/kaz_yos/
- Github: https://github.com/kaz-yos

```{r}
print(sessionInfo())
## Record execution time and multicore use
end_time <- Sys.time()
diff_time <- difftime(end_time, start_time, units = "auto")
cat("Started  ", as.character(start_time), "\n",
    "Finished ", as.character(end_time), "\n",
    "Time difference of ", diff_time, " ", attr(diff_time, "units"), "\n",
    "Used ", foreach::getDoParWorkers(), " cores\n",
    "Used ", foreach::getDoParName(), " as backend\n",
    sep = "")
```
